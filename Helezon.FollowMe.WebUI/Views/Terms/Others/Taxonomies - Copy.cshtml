@*<div class="note note-success">
        <span class="label label-danger">NOTE!</span>
        <span class="bold">Nestable List Plugin </span> supported in Firefox, Chrome, Opera, Safari, Internet Explorer 10 and Internet Explorer 9 only. Internet Explorer 8 not supported. For more info please check out
        <a href="http://dbushell.github.com/Nestable/"
           target="_blank">the official documentation</a>.
    </div>*@


@model List<FollowMe.Web.Models.Terms>
@{

    var showNestableList = ViewBag.ShowNestableList != null && (bool)ViewBag.ShowNestableList;

}

<div class="portlet light portlet-fit portlet-form bordered">
    <div class="portlet-title">
        <div class="caption">
            <i class="icon-bubble font-purple"></i>
            <span class="caption-subject font-purple sbold uppercase">Add New Item  </span>
        </div>
        <div class="actions">
            @*<div class="btn-group btn-group-devided" data-toggle="buttons">
                <label class="btn btn-transparent red btn-outline btn-circle btn-sm active">
                    <input type="radio" name="options" class="toggle" id="option1">Actions
                </label>
                <label class="btn btn-transparent red btn-outline btn-circle btn-sm">
                    <input type="radio" name="options" class="toggle" id="option2">Settings
                </label>
            </div>*@
        </div>
    </div>
    <div class="portlet-body">
        <!-- BEGIN FORM-->
        <form action="@Url.Action(actionName:"Taxonomies",controllerName:"Terms")" id="form_terms" method="post" class="form-horizontal">
            <div class="form-body">
                <div class="form-group">
                    @Html.Label("CompanyId", htmlAttributes: new { @class = "control-label col-md-3" })
                    <div class="col-md-4">
                        <div class="input-group">
                            @Html.DropDownList("CompanyId", null, optionLabel: "Please Select", htmlAttributes: new { @class = "form-control select2" })
                            <span class="input-group-btn">
                                <button class="btn blue ajax-demo" data-url="@Url.Action("Edit", "Company")" data-toggle="modal" type="button">
                                    <i class="icon-plus"></i>
                                </button>
                                @*<button class="btn green ajax-refresh" data-url="@Url.Action("DropDownListRefresh", "Base")" data-dropdownlistid="CompanyId" data-table-name="Company" type="button">
                                        <i class="icon-refresh"></i>
                                    </button>*@
                                @*<button class="btn red ajax-taxonomies" data-url="@Url.Action("Taxonomies", "Terms")" data-dropdownlistid="CompanyId" data-table-name="Company" type="button">
                                        <i class="icon-refresh"></i>
                                    </button>*@
                            </span>
                        </div>
                        @*@Html.ValidationMessageFor(x => x.CompanyId, "", new { @class = "text-danger" })*@
                    </div>
                </div>
                <div class="form-group">
                    <label for="inputItemName" class="col-md-3 control-label">Taxonomies:</label>
                    <div class="col-md-4">
                        @Html.DropDownList("TaxonomyId", null, optionLabel: "Please Select", htmlAttributes: new { @class = "form-control select2 " })
                    </div>
                </div>
                @if (showNestableList)
                {
                    <div class="form-group">
                        <label for="inputItemName" class="col-md-3 control-label">Item Name:</label>
                        <div class="col-md-4">
                            <div class="input-group">
                                <input type="text" class="form-control" id="inputItemName" placeholder="Item Name">
                                <span class="input-group-btn">
                                    <button id="buttonAddNewItem" class="btn btn-default" type="button">
                                        <span class="glyphicon glyphicon-plus"></span>
                                    </button>
                                </span>
                            </div>
                        </div>
                    </div>
                }

                @*<div class="form-group">
                        <div class="col-md-offset-2 col-md-10">
                            @Html.Hidden("Taxonomy", (ViewBag.Taxonomy != null ? (string)ViewBag.Taxonomy : string.Empty))
                        </div>
                    </div>*@
            </div>
            <div class="form-actions">
                <div class="row">
                    <div class="col-md-offset-3 col-md-9">
                        @*<button type="submit" class="btn green">Submit</button>
                        <button type="button" class="btn grey-salsa btn-outline">Cancel</button>*@
                    </div>
                </div>
            </div>
        </form>
        <!-- END FORM-->
    </div>
</div>




@if (showNestableList)
{
    <div class="row">
        <div class="col-md-6">
            <div class="portlet light bordered">
                <div class="portlet-title">
                    <div class="caption">
                        <i class="icon-bubble font-green"></i>
                        <span class="caption-subject font-green sbold uppercase"> New Nestable List </span>
                    </div>
                    <div class="actions">
                        @*<div class="btn-group">
                            <a class="btn green-haze btn-outline btn-circle btn-sm" href="javascript:;" data-toggle="dropdown" data-hover="dropdown" data-close-others="true">
                                Actions
                                <i class="fa fa-angle-down"></i>
                            </a>
                            <ul class="dropdown-menu pull-right">
                                <li>
                                        <a href="javascript:;"> Option 1</a>
                                    </li>
                                    <li class="divider"> </li>
                                    <li>
                                        <a href="javascript:;">Option 2</a>
                                    </li>
                                    <li>
                                        <a href="javascript:;">Option 3</a>
                                    </li>
                                    <li>
                                        <a href="javascript:;">Option 4</a>
                                    </li>
                            </ul>
                        </div>*@
                    </div>
                </div>
                <div class="portlet-body ">
                    <div class="dd" id="nestable_list_1">
                        @if (Model != null && Model.Any())
                        {
                            <ol class="dd-list">
                                @foreach (var item in Model)
                                {
                                    <li class="dd-item" data-id="@item.Id">
                                        <div class="dd-handle"> @item.Name </div>
                                    </li>
                                }
                            </ol>
                        }
                        else
                        {
                            <div class="dd-empty"></div>
                        }

                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="portlet light bordered">
                <div class="portlet-title">
                    <div class="caption">
                        <i class="icon-bubble font-red"></i>
                        <span class="caption-subject font-red sbold uppercase"> Taxonomy List </span>
                    </div>
                    <div class="tools">
                        @*<a href="" class="collapse"> </a>
                        <a href="#portlet-config" data-toggle="modal" class="config"> </a>
                        <a href="" class="reload"> </a>
                        <a href="" class="remove"> </a>*@
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="dd" id="nestable_list_2">
                        @Html.Raw(ViewBag.NestedListHtmlString)
                    </div>
                </div>
            </div>
        </div>
    </div>
    @*<div class="row">
        <div class="col-md-12">
            <div class="margin-bottom-10" id="nestable_list_menu">
                <button type="button" class="btn green btn-outline sbold uppercase" data-action="expand-all">Expand All</button>
                <button type="button" class="btn red btn-outline sbold uppercase" data-action="collapse-all">Collapse All</button>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <h3>Serialised Output (per list)</h3>
            <textarea id="nestable_list_1_output" class="form-control col-md-12 margin-bottom-10"></textarea>
            <textarea id="nestable_list_2_output" class="form-control col-md-12 margin-bottom-10"></textarea>
        </div>
    </div>*@

}



@section beforeGlobalScripts {


}

@section afterGlobalScripts {

    <script>
        var postOptionTermForm = function () {

            var $TaxonomyId = $("#TaxonomyId").val();
            var $CompanyId = $("#CompanyId").val();
            if ($CompanyId.length !== 0 && $TaxonomyId.length !== 0) {
                $('#form_terms').submit();
            }
        }

        $dropDownListCompanyId = $("#CompanyId");
        $dropDownListTaxonomyId = $("#TaxonomyId");

        $dropDownListCompanyId.change(function () {
            postOptionTermForm();
        });


        $dropDownListTaxonomyId.change(function () {
            postOptionTermForm();
        });
    </script>


 
        <script src="~/Content/pages/scripts/ui-nestable.js" type="text/javascript"></script>

        <script>

               @if (showNestableList)
               {
                  <text> 
                    jQuery(document).ready(function () {
                        UINestable.init();
                    });
                 </text>                  
               }




            $(document).ready(function ()   {

                   var $waitingRefresh = false;

                   var refreshNestableList = function () {
                       if ($waitingRefresh) {
                           return;
                       }
                $waitingRefresh = true;
                       //console.log("$('#nestable_list_1 .dd').nestable('serialize')");
                       //console.log($('#nestable_list_1 .dd').nestable('serialize'));
                       //console.log($("#nestable_list_1_output").val());

                       var $TaxonomyId = $("#TaxonomyId").val();
                       var $CompanyId = $("#CompanyId").val();

                       if ($CompanyId.length !== 0 && $TaxonomyId.length !== 0) {
                           swal("Success.", "", "success");
                       } else {
                           swal("Error!", "Please Select Company!", "error");
                           return;
                       }                

                $.ajax({
                           type: "POST",
                    url: "/Terms/Term_Taxonomy?companyId=" + $CompanyId + "&taxonomy=" + $TaxonomyId,
                    data: {
                               nestableList: JSON.stringify($('#nestable_list_2').nestable('serialize'))
                    },
                    success: function (response) {
                               //console.log(response);
                               if (response.IsSucceeded) {
                                   swal("Success.", "Taxonomies Saved!", "success");

                               } else {
                                   swal("Error!", response.Message, "error");
                               }
                           },
                    failure: function (response) {
                               console.log(response);
                           },
                    error: function (response) {
                               console.log(response);
                           },
                    complete: function () {
                        $waitingRefresh = false;
                           }
                       });



                   };





                   if ($.inArray(refreshNestableList) < 0  ) {
                       UINestable.onChangeFunctions.push(refreshNestableList);
                   }


            $("#buttonAddNewItem").click(function() {
                       var $TaxonomyId = $("#TaxonomyId").val();
                       var $CompanyId = $("#CompanyId").val();
                       var $inputItemName = $("#inputItemName").val();

                       if ($CompanyId.length !== 0 && $TaxonomyId.length !== 0 && $inputItemName.length !== 0) {


                    

                $.ajax({
                               type: "POST",
                    url: "@Url.Action("AddNewTerm", "Terms")?companyId=" + $CompanyId,
                    data: '{ Name: "' + $inputItemName + '" , TaxonomyId: "' + $TaxonomyId + '" }',
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function(response) {

                                   if (response.Term_Id < 1) {
                                       swal("Error!", "Add New Item Failed", "error");
                                       return;
                                   }


                                   if ($("#nestable_list_1 > .dd-empty").length) {
                            $("#nestable_list_1 > .dd-empty").remove();
                                   }


                                   if ($("#nestable_list_1 > ol").length) {
                            $("#nestable_list_1 > ol").append("<li class=\"dd-item\" data-id=\"" +
                                response.Term_Id +
                                "\" data-name=\"" +
                                response.Name +
                                "\"> <div class=\"dd-handle\"> " +
                                response.Name +
                                " </div></li>");
                                   } else {
                            $("#nestable_list_1").append("<ol class=\"dd-list\"><li class=\"dd-item\" data-id=\"" +
                                response.Term_Id +
                                "\" data-name=\"" +
                                response.Name +
                                "\"> <div class=\"dd-handle\"> " +
                                response.Name +
                                " </div></li></ol>");
                                   }

                                   UINestable.updateOutput($('#nestable_list_1').data('output', $('#nestable_list_1_output')));
                        $("#inputItemName").val('');
                                   swal("Success.", "", "success");
                               },
                    failure: function(response) {
                                   console.log(response);
                               },
                    error: function(response) {
                                   console.log(response);
                               }
                           });
                       } else {
                           swal("Error!", "Please Select Company or Taxonomy or Enter Item Name!", "error");
                           return;
                       }





                       //updateOutput($('#nestable_list_1').data('output', $('#nestable_list_1_output')));
                       //updateOutput($('#nestable_list_2').data('output', $('#nestable_list_2_output')));

                   });




               });

        </script>
    


}